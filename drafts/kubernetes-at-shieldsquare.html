<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://sunnykrGupta.github.io/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://sunnykrGupta.github.io/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://sunnykrGupta.github.io/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Sunny KUMAR">
  <meta name="description" content="Posts and writings by Sunny KUMAR">


<meta name="keywords" content="kubernetes, docker, gce, gcr, container">

  <title>
    Daemon Blog
&ndash; Kubernetes at Shieldsquare  </title>

<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63834161-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a id="user_meta_logo" href="https://sunnykrGupta.github.io">
        <img src="https://sunnykrGupta.github.io/images/logo.jpg" alt="logo">
      </a>
      <h3><a href="https://sunnykrGupta.github.io">Sunny KUMAR</a></h3>
      <p>Data Engineer, DevOps on Kubernetes, SysAdmin, Programmer, Optimist, Footballer :D</p>
      <nav>
          <h4><a href="https://sunnykrGupta.github.io/pages/projects.html">Project</a></h4>
          <h4><a href="https://sunnykrGupta.github.io/pages/about-me.html">About</a></h4>
          <h4><a href="https://sunnykrGupta.github.io/pages/contact-me.html">Contact</a></h4>
      </nav>
    </div>
  </aside>

  <main>
    <header>
      <nav>
          <a id="github" href="https://github.com/sunnykrGupta" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-github.png" alt="github"></a>
          <a id="twitter" href="https://twitter.com/Sunny_KrGupta" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-twitter.png" alt="twitter"></a>
          <a id="linkedin" href="https://www.linkedin.com/in/sunnykrgupta/" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-linkedin.png" alt="linkedin"></a>
          <a id="googleplus" href="https://plus.google.com/u/0/+SunnyKrGUPTA" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-googleplus.png" alt="googleplus"></a>
          <a id="mail" href="mailto:sunnygupta.kr@gmail.com" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-mail.png" alt="mail"></a>
      </nav>
      <br />
      <p>
        <a href="https://sunnykrGupta.github.io/index.html">Index</a> &nbsp;&nbsp; &brvbar; <a href="https://sunnykrGupta.github.io/archives.html">&nbsp;&nbsp;Archives</a>
      </p>

    </header>

<article>
  <div class="article_title">
    <h3><a href="https://sunnykrGupta.github.io/drafts/kubernetes-at-shieldsquare.html">Kubernetes at Shieldsquare</a></h3>
  </div>
  <div class="article_text">
    <blockquote>
<p>Couple of months ago, we were struggling with scalability of system and were in pursuit of finding right orchestration tools which can help in faster deployments and scaling system quickly.</p>
</blockquote>
<p>Then, we started exploring popular project managed by Google for orchestration management, <strong><a href="https://kubernetes.io/">Kubernetes</a></strong> for DevOps. Starting with two weeks of learning curves, we get our working staging system in <strong><em>kubes</em></strong> <sub>(kubernetes in short)</sub> and did small working setup to visualize the power of this orchestration framework.</p>
<p>At <strong>Shieldsquare</strong> our pain point was scaling different version of modules on the fly and managing blue-green deployment. In our tradional model of scaling, we keep on adding server dependent on type of code we wanted to run on server (VMs) and it puts us in difficult situation when it comes to handling more traffic, we need to prepare servers to run different modules. At Shieldsquare, one advantage is we runs on purely decoupled services, each application service do transformation on data and transformed data is consumed by next service layer. We took advantage and started looking for technology that fits our requirement. We were in pursuit of moving our server management in <em>auto-pilot</em> mode.</p>
<hr>
<h4>Microservices</h4>
<p>Microservice architectures have been trending because its architectural style aims to tackle the problems of managing modern application by decoupling software solutions into smaller functional services that are expected to fail.</p>
<p>This help in quick recovery from failure on smaller functional units in contrast to making recovery from big monolithic software systems. Microservices helps in making your release cycle faster even because you will be focusing on smaller changes in single app instead of pushing code changes in bigger software systems that has multiple dependencies.</p>
<hr>
<h4>Containers</h4>
<p>Microservice architectures got a big tide in 2013 when Docker inc. released Docker technology. <strong>Docker container</strong> gave perfect replacement to virtual machines and drove software packaging methods in more developer friendly way. Docker container are comparatively smaller than virtual machines (VMs). Its shares underlying host OS resources, we can spin up hundreds of these small units in order of milliseconds. Their smaller size helps in faster packaging, testing and even deployments because of its portable nature.</p>
<p>Docker’s container-based platform allows for highly portable workloads. Docker containers can run on a developer’s local laptop, on physical or virtual machines in a data center, on cloud providers, or in a mixture of environments.</p>
<hr>
<h4>Launching on Kubernetes</h4>
<p>We started with <code>Google Container Engine (GCE)</code> to get things working quickly. We started with a cluster of <code>10 Nodes</code>, each Node with configuration <code>4 vCore and 15 GB</code> in <strong>default pool</strong> to run stateless Java components <sub>( Here at <a href="https://www.shieldsquare.com/">Shieldsquare</a> core processing relies on code written in Java)</sub>.</p>
<p>When working with Kubernetes, we must become familiar with working concepts of <code>Docker</code> and <code>Kubernetes</code>.</p>
<hr>
<h4>Understanding Docker</h4>
<ul>
<li>
<p><a href="https://www.redhat.com/en/containers">Understanding containerization concept</a></p>
<ul>
<li>Container provides operating system-level virtualization through a virtual environment that has its own process and network space, instead of creating a full-fledged <a href="https://en.wikipedia.org/wiki/Virtual_machine">virtual machine</a>. This enables the kernel of an operating system to allow the existence of multiple isolated user-space instances, instead of just one.</li>
</ul>
</li>
<li>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Writing good Dockerfile for modules</a>.</p>
<ul>
<li>Dockerfile is set of instruction used by Docker to build an image. Containers are created using docker images, which can be built either by executing commands manually or automatically through Dockerfile. Docker achieves this by creating safe, <strong>LXC</strong> (i.e. Linux Containers) based environments for applications called “docker containers”.</li>
</ul>
</li>
<li>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#each-container-should-have-only-one-concern">Running a single process inside a Docker container</a>.</p>
<ul>
<li>“one process per container” is frequently a good rule of thumb, it is not a hard and fast rule. Use your best judgment to keep containers as clean and modular as possible - Docker</li>
</ul>
</li>
<li>
<p>Understanding remote Docker container registry for storing/pushing our locally built docker images, here we have used Google container registry (GCR) for docker image management.</p>
<ul>
<li><a href="https://cloud.google.com/container-registry/docs/pushing-and-pulling">Pushing and Pulling Images to GCR</a></li>
<li><a href="https://docs.docker.com/docker-cloud/builds/push-images/">Push images to Docker Cloud</a></li>
</ul>
</li>
</ul>
<hr>
<h4>Understanding Kubernetes</h4>
<p>The Kubernetes documentation is great place to start.</p>
<ul>
<li>Learning basics of kubernetes &amp; <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">working flow training</a>.<ul>
<li>Kubernetes is an open-source platform for automating deployment, scaling, and operations of application containers across clusters of hosts, providing container-centric infrastructure - Kubernetes.io</li>
</ul>
</li>
</ul>
<blockquote>
<p>Defining correct Node resources in kubernetes cluster.</p>
</blockquote>
<p>Each container has its own requirements of resources (ie, CPU or RAM, disk, network etc), there comes <a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-ram-container/">requests &amp; limits in kubes</a>. This helps alot in keeping your nodes healthy. Many times due to bad limits or not defining limits on resources, your pods could go crazy at utilization, eat any resources which lead to node starvation and node goes in <code>[Not Ready]</code> state due to resource exhaustion. We had this multiple times at early stage and now we had fine tuned each pods resources based on its hunger behaviour.</p>
<p>Depends on container type <sub>(which you are running inside a pod)</sub>, you can define different Node pools. Suppose you have modules named <code>Core-X, Core-Y and Core-Z</code> , all of them needs <code>2 Core, 2 GB</code> each to run, then you can have <strong>Standard Node Pool</strong> to run them. In this case, i will allocate below config for my Node pool.</p>
<ul>
<li>Name : Standard Pool</li>
<li>Pool Size : 2</li>
<li>Node Config: 4 Core, 4 GB</li>
<li>Node Pool Size : 8 Core, 8 GB</li>
<li><code>Utilization</code> : 6 Core, 6 GB (75 % used Core &amp; RAM)</li>
</ul>
<p>Now, lets say i have high memory eater modules. let call them <code>Mem-X, Mem-Y and Mem-Z</code> , all of them needs <code>0.5 Core, 4 GB</code> each to run, then you need <strong>High memory Node Pool</strong> to run them. In this case, i will allocate now below config for my Node pool.</p>
<ul>
<li>Name : HighMem Pool</li>
<li>Pool Size : 2</li>
<li>Node Config : 1 Core, 8 GB</li>
<li>Node Pool : 2 Core, 16 GB</li>
<li><code>Utilization</code> : 1.5 Core, 12 GB (75 % used Core &amp; RAM)</li>
</ul>
<blockquote>
<p>So, based on your <a href="https://cloud.google.com/container-engine/docs/node-pools">Node pool type</a>, you can deploy your pods in different Node pools by using <code>nodeSelector</code> directives in configuration.</p>
</blockquote>
<div class="highlight"><pre>-------------- Node selector example

apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx-v1
    image: nginx
  nodeSelector:
    #give label assigned to your node pool
    cloud.google.com/gke-nodepool: high-mem-pool
</pre></div>


<hr>
<h4>Blue-green deployments in Shieldsquare</h4>
<p>A blue-green deployment works by starting a cluster of replicas running the new version while all the old replicas are still serving all the live requests. When the new version of replicas is completely functioning, we switch the flip by decreasing the number of replicas of older version. A benefit of this approach, there is always only one version of application running, Its helps in reducing deployments complexity of handling multiple concurrent versions. If in any case, released version doesnt work out well in production, kubernetes maintains history of version rolled out, we can do rollback of deployments easily.</p>
<hr>
<h4>How we monitor Kubernetes</h4>
<p>We have our custom monitoring monitoring setup to keep an eye on Nodes. We run a <a href="https://github.com/kubernetes/heapster">heapster</a> responsible for compute resource usage analysis and monitoring of container clusters, hooked with <a href="https://github.com/influxdata/influxdb">influxdb</a> that consumes reporting done by heapster and we visualize graphs in <a href="https://grafana.com/">grafana</a>.</p>
<div style="text-align: right"><sub>Monitoring at Shieldsquare</sub></div>

<p><img alt="Grafana monitoring" src="/images/kubes/grafana.png" title="Grafana monitoring"></p>
<blockquote>
<p>Um! What about logs?</p>
</blockquote>
<p>Right, logs are very important. We have ELK (Elasticsearch, Logstash, Kibana) to consume logs reported by containers running in cluster. Containers is running with <a href="https://logging.apache.org/log4j">log4j</a> (log4j is a reliable, fast and flexible logging framework (APIs) written in Java,) configured to push logs through logstash to Elasticsearch.</p>
<div class="highlight"><pre>#log4j configuration for application
log4j.rootLogger=ERROR, server

#We will use socket appender
log4j.appender.server=org.apache.log4j.net.SocketAppender

#Port where socket server will be listening for the log events
log4j.appender.server.Port=6083

#Host name or IP address of socket server
log4j.appender.server.RemoteHost=app-logstash.server.net

#Define any connection delay before attempting to reconnect
log4j.appender.server.ReconnectionDelay=10000
</pre></div>


<hr>
<h4>Data stores and Kubernetes</h4>
<p>Kubernetes is more about running stateless containers. At shieldsquare, we mostly use kubernetes to run tools that don't need persistency ie, caching, temporary data. Its not meant for stateful components like, MySQL or MongoDB or any other engine that extensively work with data at rest. So, we are not running our production data stores inside Kubernetes. However, Kubernetes have support for stateful containers management too but still at mature stage. The important learning is that you don’t have to run everything in Kubernetes and orchestrate only applications which are stateless.</p>
<hr>
<h4>Cost Impact</h4>
<p>With Kubernetes cluster, we brought down cost by 40% on Google Cloud Platform. We have managed to run tightly coupled containers inside a different node pools. We have plenty of services, some are core intensive and couple of them are memory hungry, we let kubernetes manage and fit the containers in right place without us worrying about how to maximize the utilization.</p>
<hr>
<p><strong>Note :</strong> Some configuration in GCE should be taken care, like <code>autoupgrade kubernetes version</code>. If you are running RabbitMQ, Redis or any other message queue as service that needs uptime, better you turn off autoupgrade because kubernetes new version release comes, all node will be scheduled for maintenance, however it rolles updates one by one but could affect your production system. Else, if you are fully stateless, you can keep default or skip this warning!.</p>
<div class="highlight"><pre>----Autoupgrade off

# https://cloud.google.com/container-engine/docs/node-auto-upgrade

gcloud beta container node-pools update &lt;NODEPOOL&gt; --cluster &lt;CLUSTER&gt; --zone &lt;ZONE&gt; --no-enable-autoupgrade
</pre></div>


<p>Pretty much all above understanding are based on what we learned in last four months of kubernetes running in production. Container management is easy to adapt and lot of new observation is yet to be discovered as we go along the way.</p>
<p>Looking at our deployments today, Kubernetes is absolutely fantastic. We currently managed to put the system in place to process ``5 Billion APIs``` call per month and are pushing more to handle.</p>
<hr>
<blockquote>
<p>Conclusion : <code>Kubernetes</code> lifted alot of <code>server management</code> and helped in faster depployments &amp; scaling system. Adaptability is much quicker, most of security and other concerns is being managed by Google. Kubernetes aims to offer a better orchestration management system on top of clustered infrastrcuture. Development on Kubernetes has been happening at storm-speed, and the <a href="https://kubernetes.io/community/">community of Kubernauts</a> has grown bigger.</p>
</blockquote>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 02 May 2017</p>
    <p>Category: <a href="https://sunnykrGupta.github.io/category/kubernetes-docker-gce-gcr-container.html">kubernetes, docker, gce, gcr, container</a>
 &ndash; Tags:
      <a href="https://sunnykrGupta.github.io/tag/kubernetes.html">kubernetes</a>,      <a href="https://sunnykrGupta.github.io/tag/docker.html">docker</a>,      <a href="https://sunnykrGupta.github.io/tag/gce.html">gce</a>,      <a href="https://sunnykrGupta.github.io/tag/gcr.html">gcr</a>,      <a href="https://sunnykrGupta.github.io/tag/container.html">container</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "drafts/kubernetes-at-shieldsquare.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://sunnydaemon.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; Sunny KUMAR. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. Member of the <a href="http://internetdefenseleague.org">Internet Defense League</a>.</p>
    </div>
  </main>

  <div id="right-feed">
    <a class="twitter-timeline" href="https://twitter.com/sunnyLAGupta" data-widget-id="605800181926199296">Tweets by @sunnyLAGupta</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>
<script type="text/javascript">
  window._idl = {};
  _idl.variant = "banner";
  (function() {
    var idl = document.createElement('script');
    idl.type = 'text/javascript';
    idl.async = true;
    idl.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'members.internetdefenseleague.org/include/?url=' + (_idl.url || '') + '&campaign=' + (_idl.campaign || '') + '&variant=' + (_idl.variant || 'banner');
    document.getElementsByTagName('body')[0].appendChild(idl);
  })();
</script>
</body>
</html>