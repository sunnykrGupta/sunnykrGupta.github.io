<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://sunnykrGupta.github.io/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://sunnykrGupta.github.io/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://sunnykrGupta.github.io/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Sunny KUMAR">
  <meta name="description" content="Posts and writings by Sunny KUMAR">


<meta name="keywords" content="kubernetes, docker, gce, gcr, container">

  <title>
    Daemon Blog
&ndash; Managing fleet on Kubernetes  </title>

<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63834161-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a id="user_meta_logo" href="https://sunnykrGupta.github.io">
        <img src="https://sunnykrGupta.github.io/images/logo.jpg" alt="logo">
      </a>
      <h3><a href="https://sunnykrGupta.github.io">Sunny KUMAR</a></h3>
      <p>Data Engineer, DevOps on Kubernetes, SysAdmin, Programmer, Optimist, Footballer :D</p>
      <nav>
          <h4><a href="https://sunnykrGupta.github.io/pages/projects.html">Project</a></h4>
          <h4><a href="https://sunnykrGupta.github.io/pages/about-me.html">About</a></h4>
          <h4><a href="https://sunnykrGupta.github.io/pages/contact-me.html">Contact</a></h4>
      </nav>
    </div>
  </aside>

  <main>
    <header>
      <nav>
          <a id="github" href="https://github.com/sunnykrGupta" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-github.png" alt="github"></a>
          <a id="twitter" href="https://twitter.com/Sunny_KrGupta" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-twitter.png" alt="twitter"></a>
          <a id="linkedin" href="https://www.linkedin.com/in/sunnykrgupta/" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-linkedin.png" alt="linkedin"></a>
          <a id="googleplus" href="https://plus.google.com/u/0/+SunnyKrGUPTA" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-googleplus.png" alt="googleplus"></a>
          <a id="mail" href="mailto:sunnygupta.kr@gmail.com" target="_blank"><img src="https://sunnykrGupta.github.io/theme/images/Mono/webicon-mail.png" alt="mail"></a>
      </nav>
      <br />
      <p>
        <a href="https://sunnykrGupta.github.io/index.html">Index</a> &nbsp;&nbsp; &brvbar; <a href="https://sunnykrGupta.github.io/archives.html">&nbsp;&nbsp;Archives</a>
      </p>

    </header>

<article>
  <div class="article_title">
    <h3><a href="https://sunnykrGupta.github.io/managing-fleet-on-kubernetes.html">Managing fleet on Kubernetes</a></h3>
  </div>
  <div class="article_text">
    <p>Couple of months ago, we were struggling with scalability of system and were in pursuit of finding right orchestration tools which can help in scaling modules.</p>
<p>Then, we started exploring popular project managed by Google for orchestration management, Kubernetes for DevOps. Starting with two weeks of learning curves, we get our working staging system in kubes (kubernetes in short) and did small working setup to visualize the power of this orchestration framework.</p>
<p>We started with GCE (Google Container Engine) to get things working quickly. We created a cluster of 10 Nodes, each Node with configuration 4 vCore and 15 GB in default pool to run stateless Java components (in Shieldsquare core processing relies on code written in Java).</p>
<p>Before we go in depth, we did some research and found out we needed some gears(concepts/tools/theory) before board into container ship and sail out for cruise. We are dividing gears we need to know into two parts, ie, first will be Docker and second will focus on Kubernetes.</p>
<p>Part - I (Understanding Docker at Dock)
- Stateless and stateful components.
- Understanding containerization concept.
- Writing good Dockerfile for modules.
- Writing Optimized Dockerfile, understanding order of dynamic commands (ie, commands that we will change according to need for making other docker images) and commands that we will keep same in all Docker images. It helps in quick building of next Docker image. Each command that we run in Dockerfile is executed as a layer and subsequent command will be build on top of previous layer. Each layer is managed in cache by Docker tool. Docker manages cache itself to reuse layer of previously build Docker images to save time, network bandwidth &amp; disk.</p>
<p>------------------Ex :</p>
<ul>
<li>Running a single process inside a Docker container</li>
<li>Understanding remote Docker container registry for storing/pushing our locally built docker images, here we have used Google container registry (GCR) for docker image management.</li>
</ul>
<p>Part - II (Understanding Kubernetes fleet)
- Learning basics of kubernetes &amp; working flow
- What are Pods! How container runs inside a pod.
- What are Nodes (also known as worker or minion, a single machine)
- What are deployments!
- What is replication controller and Replica sets!
- What is Kubernetes master!
- What are services!
- What is label selectors!
- How to debug or get cluster info from command-line!
    ---------kubectl commands</p>
<blockquote>
<p>How do we run containers in GCE ?
We have number of deployments which manages scaling pods up/down depend on processing we need. We need to follow proper versioning of modules to distinguish what is running inside your system and this helps in rollback releases in case of issues in production.
    How about services/APIs we need to expose ?
- There comes kubes services. We have plenty of APIs we need to expose to outside world. To make it happen, we have couple of kube services exposed using tcp loadbalancer which has been assigned public IP. Internally, these services keeps on doing service discovery using label selector to find pods and attached to this service, pods having same label will be targeted by a service. Its same concept of how we manage loadbalancer on cloud, attach VMs to a loadbalancer to offload incoming traffic.</p>
</blockquote>
<ul>
<li>Resources running inside Kube ship know each other very well. Each services/pods can communicate by names assigned to each. Instead of using IPs (private) assigned to each of them, you can use names as FQDN given and its a good practise to use names instead of IPs because of dynamic allocation of IPs as resources get destroyed and created again. Kube-DNS maintains all list of IPs internally assigned and helps finding resources by names.</li>
</ul>
<blockquote>
<p>How to decide what resources you should allocate to your kubernetes Cluster or define pools resources?
[http: // Setting pods CPU and Memory limits (M vs Mi)]</p>
</blockquote>
<p>Each container has its own requirements of resources (ie, CPU or RAM, disk, network etc), there comes requests &amp; limits in kubes. This helps alot in keeping your nodes healthy. Many times due to bad limits or not defining limits, your pods can go crazy at utilization, eat any resources and can lead to node starvation and lead to Node becomes unhealthy and goes in [Not Ready] state due to resource exhaustion. We had this multiple times at early stage and now we had fine tuned each pods resources based on its hunger behaviour.</p>
<div class="highlight"><pre>How to define Node resources?
</pre></div>


<p>Depends on container type (which you are running inside a pod), you can define different resource pools. Suppose you have modules named Core.X, Core.Y and Core.Z , all of them needs 2 core, 2 GB each to run, then you can have Standard Node Pool to run them. In this case, i will allocate below config for my Node pool.</p>
<ul>
<li>Name : Standard Pool</li>
<li>Pool Size : 2</li>
<li>Node Config: 4 Core, 4 GB</li>
<li>Node Pool Size : 8 Core, 8 GB</li>
<li>Utilization : 6 Core, 6 GB (75 % used Core &amp; RAM)</li>
</ul>
<p>Now, lets say i have high memory eater modules. let call them Mem.X, Mem.Y and Mem.Z , all of them needs 0.5 core, 4 GB each to run, then you need high memory Node Pool to run them. In this case, i will allocate below config for my Node pool.</p>
<ul>
<li>Name : HighMem Pool</li>
<li>Pool Size : 2</li>
<li>Node Config : 1 Core, 8 GB</li>
<li>Node Pool : 2 Core, 16 GB</li>
<li>Utilization : 1.5 Core, 12 GB (75 % used Core &amp; RAM)</li>
</ul>
<p>So, based on your Node types, you can deploy your pods in different Node pools by using Node selector in kube.</p>
<p>-------------- Node selector example</p>
<p>Note : Some configuration in GCE should be taken care, like autoupgrade kubernetes version. If you are running redis or any other cache manager that needs uptime, better you turn off autoupgrade because when kubernetes release comes all node will go on scheduled maintenance one by one and that could affect your production system. Else, you are fully stateless, you can keep default.</p>
<p>-------------- Autoupgrade off/on</p>
<p>Pretty much all above theories are based on what we understood in last three months of kubernetes running in production. Container management is easy to adapt and lot of new observation is yet to be discovered as we go along the way. We currently managed to put the system in place to process 10 Billion APIs call per month and are pushing more to handle.</p>
<p>Conclusion : Kubernetes lifted alot of DevOps management and helped in scaling system. Adaptability is much quicker, most of security and other concerns is being managed by Google. Kubernetes aims to offer a better orchestration management system on top of clustered infrastrcuture.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 02 May 2017</p>
    <p>Category: <a href="https://sunnykrGupta.github.io/category/kubernetes-docker-gce-gcr-container.html">kubernetes, docker, gce, gcr, container</a>
 &ndash; Tags:
      <a href="https://sunnykrGupta.github.io/tag/kubernetes.html">kubernetes</a>,      <a href="https://sunnykrGupta.github.io/tag/docker.html">docker</a>,      <a href="https://sunnykrGupta.github.io/tag/gce.html">gce</a>,      <a href="https://sunnykrGupta.github.io/tag/gcr.html">gcr</a>,      <a href="https://sunnykrGupta.github.io/tag/container.html">container</a>    </p>
  </div>
  <section>
      <p id="post-share-links">
          Share on:
          <a href="http://twitter.com/home?status=Managing%20fleet%20on%20Kubernetes%20https%3A//sunnykrGupta.github.io/managing-fleet-on-kubernetes.html" target="_blank" title="Share on Twitter"><img src="https://sunnykrGupta.github.io/theme/images/Share/twitter.svg" alt="twitter"></a>
          <a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//sunnykrGupta.github.io/managing-fleet-on-kubernetes.html" target="_blank" title="Share on Facebook"><img src="https://sunnykrGupta.github.io/theme/images/Share/facebook.svg" alt="facebook"></a>
          <a href="https://plus.google.com/share?url=https%3A//sunnykrGupta.github.io/managing-fleet-on-kubernetes.html" target="_blank" title="Share on Google Plus"><img src="https://sunnykrGupta.github.io/theme/images/Share/googleplus.svg" alt="google+"></a>
          <a href="mailto:?subject=Managing%20fleet%20on%20Kubernetes&amp;body=https%3A//sunnykrGupta.github.io/managing-fleet-on-kubernetes.html" target="_blank" title="Share via Email"><img src="https://sunnykrGupta.github.io/theme/images/Share/mail.svg" alt="email"></a>
      </p>
  </section>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "managing-fleet-on-kubernetes.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'http://sunnydaemon.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; Sunny KUMAR. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. Member of the <a href="http://internetdefenseleague.org">Internet Defense League</a>.</p>
    </div>
  </main>

  <div id="right-feed">
    <a class="twitter-timeline" href="https://twitter.com/sunnyLAGupta" data-widget-id="605800181926199296">Tweets by @sunnyLAGupta</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>
<script type="text/javascript">
  window._idl = {};
  _idl.variant = "banner";
  (function() {
    var idl = document.createElement('script');
    idl.type = 'text/javascript';
    idl.async = true;
    idl.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'members.internetdefenseleague.org/include/?url=' + (_idl.url || '') + '&campaign=' + (_idl.campaign || '') + '&variant=' + (_idl.variant || 'banner');
    document.getElementsByTagName('body')[0].appendChild(idl);
  })();
</script>
</body>
</html>